<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>WebCrypto CSE + KMS</title>
  <style>
    body {
      font-family: "Helvetica Neue", sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
      color: #333;
    }
    h3 {
      color: #2c3e50;
    }
    button {
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    button:hover {
      background-color: #2980b9;
    }
    #output {
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      white-space: pre-wrap;
      margin-top: 10px;
      height: 200px;
      overflow-y: auto;
    }
    input[type="file"] {
      margin-top: 10px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .logout-btn {
      padding: 6px 12px;
      font-size: 14px;
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .logout-btn:hover {
      background-color: #c0392b;
    }
  </style>
</head>
<body>
  <div class="header">
    <div><strong>歡迎，{{ session['username'] }}！</strong></div>
    <form action="{{ url_for('logout') }}" method="get">
      <button class="logout-btn">登出</button>
    </form>
  </div>

  <h3>WebCrypto + 模擬 KMS 公鑰</h3>
  <button onclick="runDemo()">Run Demo</button>
  <input type="file" id="fileInput" />
  <pre id="output"></pre>

  <script>
    async function runDemo() {
      const output = document.getElementById("output");

      const aesKey = await window.crypto.subtle.generateKey(
        { name: "AES-GCM", length: 256 },
        true,
        ["encrypt", "decrypt", "wrapKey"]
      );
      output.textContent += "✅ AES 金鑰已產生\n";

      const res = await fetch('/static/public_key.txt');
      output.textContent += "✅ 成功得到公鑰\n";
      console.log("有進到 fetch 段落！");
      const pem = await res.text();
      output.textContent += "✅ test1\n";
      console.log(pem);   

      const pemHeader = "-----BEGIN PUBLIC KEY-----";
      const pemFooter = "-----END PUBLIC KEY-----";

      const pemHeaderIndex = pem.indexOf(pemHeader);
      const pemFooterIndex = pem.indexOf(pemFooter);

      if (pemHeaderIndex === -1 || pemFooterIndex === -1) {
        throw new Error("找不到公鑰 header/footer");
      }
    
      const start = pem.indexOf(pemHeader) + pemHeader.length;
      const end = pem.indexOf(pemFooter);

      let pemContents = pem.substring(start, end);
      pemContents = pemContents.replace(/\s+/g, "");
      console.log("PEM contents (Base64):", pemContents);

      const binaryDerString = window.atob(pemContents);
      output.textContent += "✅ test1\n";
      const binaryDer = new Uint8Array(binaryDerString.length);
      for (let i = 0; i < binaryDerString.length; i++) {
        binaryDer[i] = binaryDerString.charCodeAt(i);
      }
  
      console.log("Binary DER data:", binaryDer);
      output.textContent += "✅ test1\n";
      let publicKey;
  
      try {
        publicKey = await window.crypto.subtle.importKey(
          "spki",
          binaryDer.buffer,
          { name: "RSA-OAEP", hash: "SHA-256" },
          false,
          ["encrypt", "wrapKey"]
        );
        console.log("Public key imported successfully", publicKey);
      } catch (error) {
        console.error("Error importing public key: ", error);
        return;
      }
      output.textContent += "✅ test1\n";
      output.textContent += "✅ KMS 公鑰匯入完成\n";

      const wrappedKey = await window.crypto.subtle.wrapKey(
        "raw",
        aesKey,
        publicKey,
        { name: "RSA-OAEP" }
      );
      output.textContent += "✅ AES 金鑰已用 KMS 公鑰包裝\n";

      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];

      if (!file) {
        output.textContent += "❌ 請先選擇一個檔案\n";
        return;
      }

      const reader = new FileReader();
      reader.onload = async function () {
        const fileContent = reader.result;
        const iv = window.crypto.getRandomValues(new Uint8Array(12));

        try {
          const ciphertext = await window.crypto.subtle.encrypt(
            { name: "AES-GCM", iv: iv },
            aesKey,
            fileContent
          );

          output.textContent += "✅ 檔案內容已加密\n";

          const ciphertextArray = new Uint8Array(ciphertext);
          const blob = new Blob([ciphertextArray], { type: "application/octet-stream" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "encrypted_file.bin";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          output.textContent += "✅ 已觸發下載加密檔案\n";
        } catch (error) {
          output.textContent += "❌ 加密過程中發生錯誤\n";
          console.error(error);
        }
      };

      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
